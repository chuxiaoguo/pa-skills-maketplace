---
import Layout from '../../layouts/Layout.astro';
import skillsData from '../../data/skills.json';

// 生成所有技能详情页的静态路径
export function getStaticPaths() {
  const { skills } = skillsData;

  return skills.map((skill) => ({
    params: { id: skill.id },
    props: { skill },
  }));
}

const { skill } = Astro.props;

const rawBaseUrl = import.meta.env.BASE_URL || '/';
const baseUrl = rawBaseUrl === '/' ? '' : rawBaseUrl.replace(/\/$/, '');

// 读取技能详细内容
let skillContent = '';
let skillFiles: any[] = [];
try {
  const contentModule = await import(`../../data/contents/${skill.id}.json`);
  skillContent = contentModule.default?.content || contentModule.content || '';
  skillFiles = contentModule.default?.files || contentModule.files || [];
} catch (e) {
  console.warn(`无法加载技能内容: ${skill.id}`);
}

// 获取标签颜色
function getTagColor(tagName: string): string {
  const colors: Record<string, string> = {
    'brainstorming': 'bg-purple-100 text-purple-800',
    'design': 'bg-pink-100 text-pink-800',
    'requirements': 'bg-blue-100 text-blue-800',
    'planning': 'bg-green-100 text-green-800',
    'file-io': 'bg-yellow-100 text-yellow-800',
    'bun': 'bg-orange-100 text-orange-800',
    'filesystem': 'bg-cyan-100 text-cyan-800',
    'file-operations': 'bg-indigo-100 text-indigo-800',
  };
  return colors[tagName] || 'bg-gray-100 text-gray-800';
}

// 获取第一个标签作为返回分类
const backTag = skill.tags[0];

// 页面标题
const title = `${skill.name} - 技能详情 - PA Skills Marketplace`;

// Markdown 格式化辅助函数
function formatMarkdownLine(line: string): string {
  // Escape HTML
  const escaped = line
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');

  // Simple markdown formatting
  return escaped
    // Headers
    .replace(/^#### (.*$)/, '<h4 class="text-lg font-semibold mt-4 mb-2">$1</h4>')
    .replace(/^### (.*$)/, '<h3 class="text-xl font-semibold mt-5 mb-3">$1</h3>')
    .replace(/^## (.*$)/, '<h2 class="text-2xl font-bold mt-6 mb-4 text-gray-900">$1</h2>')
    .replace(/^# (.*$)/, '<h1 class="text-3xl font-bold mt-8 mb-6 text-gray-900">$1</h1>')
    // Code blocks (start/end markers)
    .replace(/^```(\w+)?$/, '<div class="my-4 rounded-lg overflow-hidden"><pre class="bg-gray-900 text-gray-100 p-4 overflow-x-auto text-sm"><code>')
    .replace(/^```$/, '</code></pre></div>')
    // Inline code
    .replace(/`([^`]+)`/g, '<code class="bg-gray-100 text-gray-800 px-1.5 py-0.5 rounded text-sm font-mono">$1</code>')
    // Bold
    .replace(/\*\*(.+?)\*\*/g, '<strong class="font-semibold">$1</strong>')
    // Italic
    .replace(/\*(.+?)\*/g, '<em class="italic">$1</em>')
    // Bullet points
    .replace(/^- (.+$)/, '<li class="ml-4 flex items-start gap-2"><span class="text-primary-500 mt-2">•</span><span>$1</span></li>')
    // Links
    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" class="text-primary-600 hover:text-primary-800 underline">$1</a>')
    // Empty lines
    .replace(/^$/, '<br />')
    // Regular text
    .replace(/^(?!<[h|l|d|b|p])(.+$)/, '<p class="my-2 text-gray-700 leading-relaxed">$1</p>');
}
---

<Layout title={title}>
  <!-- Header -->
  <section class="bg-gradient-to-br from-primary-600 via-primary-700 to-primary-800 text-white py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumb -->
      <nav class="mb-4">
        <ol class="flex items-center gap-2 text-sm text-primary-100">
          <li><a href={`${baseUrl}/`} class="hover:text-white transition-colors">首页</a></li>
          <li>/</li>
          {backTag && (
            <>
              <li><a href={`${baseUrl}/category/${backTag}`} class="hover:text-white transition-colors">{backTag}</a></li>
              <li>/</li>
            </>
          )}
          <li class="text-white">{skill.name}</li>
        </ol>
      </nav>

      <div class="flex items-center gap-4">
        <div class="flex-shrink-0 w-16 h-16 bg-white/20 backdrop-blur-sm rounded-xl flex items-center justify-center text-3xl">
          {skill.name.charAt(0).toUpperCase()}
        </div>
        <div>
          <h1 class="text-3xl font-bold">{skill.name}</h1>
          <p class="text-primary-100 mt-1">{skill.description}</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Skill Overview -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">技能概览</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
              <div>
                <span class="text-gray-500">名称</span>
                <p class="font-medium text-gray-900">{skill.name}</p>
              </div>
              <div>
                <span class="text-gray-500">版本</span>
                <p class="font-medium text-gray-900">v{skill.version}</p>
              </div>
              <div>
                <span class="text-gray-500">作者</span>
                <p class="font-medium text-gray-900">{skill.author}</p>
              </div>
              <div>
                <span class="text-gray-500">更新日期</span>
                <p class="font-medium text-gray-900">{skill.updatedAt}</p>
              </div>
            </div>

            <!-- Tags -->
            <div class="mt-4 pt-4 border-t border-gray-100">
              <span class="text-gray-500 text-sm">标签：</span>
              <div class="flex flex-wrap gap-2 mt-2">
                {skill.tags.length > 0 ? (
                  skill.tags.map((tag) => (
                    <a href={`${baseUrl}/category/${tag}`} class={`skill-tag ${getTagColor(tag)}`}>
                      #{tag}
                    </a>
                  ))
                ) : (
                  <span class="text-gray-400 text-sm">无标签</span>
                )}
              </div>
            </div>
          </div>

          <!-- File Structure (Only show if multiple files) -->
          {skill.hasMultipleFiles && skillFiles.length > 0 && (
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h2 class="text-lg font-semibold text-gray-900 mb-4">文件结构</h2>
              <div class="bg-gray-50 rounded-lg p-4">
                <ul class="space-y-1" id="file-tree">
                  {skillFiles.map((file, index) => (
                    <li>
                      <button
                        class={`file-tree-item w-full text-left px-3 py-2 rounded-md text-sm flex items-center gap-2 transition-colors ${index === 0 ? 'bg-primary-100 text-primary-800' : 'hover:bg-gray-100 text-gray-700'}`}
                        data-file-index={index}
                      >
                        {file.type === 'markdown' ? (
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                          </svg>
                        ) : file.type === 'code' ? (
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                          </svg>
                        ) : (
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                          </svg>
                        )}
                        {file.name}
                      </button>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          )}

          <!-- File Content -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
              {skill.hasMultipleFiles ? '文件内容' : 'SKILL.md'}
            </h2>
            <div id="file-content" class="prose prose-gray max-w-none">
              {skillContent ? (
                <article class="markdown-content">
                  {skillContent.split('\n').map((line) => (
                    <div set:html={formatMarkdownLine(line)} />
                  ))}
                </article>
              ) : (
                <p class="text-gray-500">暂无内容</p>
              )}
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="space-y-6">
          <!-- Install Command -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              安装方式
            </h3>
            <p class="text-sm text-gray-500 mb-3">使用 pa-skills CLI 安装此技能：</p>
            <div class="relative">
              <pre class="code-block text-sm"><code id="install-command">{skill.installCommand}</code></pre>
              <button
                class="absolute top-2 right-2 p-2 bg-white/10 hover:bg-white/20 rounded-md text-gray-400 hover:text-white transition-colors"
                onclick="copyInstallCommand()"
                title="复制命令"
              >
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
              </button>
            </div>
            <p class="mt-3 text-xs text-gray-400">
              需要已安装 <a href="https://gitlab.company.com/pa-skills" class="text-primary-600 hover:underline">pa-skills</a> CLI
            </p>
          </div>

          <!-- Download -->
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
              <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
              </svg>
              资源下载
            </h3>
            <p class="text-sm text-gray-500 mb-3">下载此技能的完整资源包：</p>
            <a
              href={skill.downloadUrl}
              download
              class="btn-primary w-full flex items-center justify-center gap-2"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              下载 ZIP
            </a>
            <p class="mt-3 text-xs text-gray-400 text-center">
              包含此技能的所有文件
            </p>
          </div>

          <!-- Related Skills -->
          {skill.tags.length > 0 && (
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">相关技能</h3>
              <ul class="space-y-3">
                {skillsData.skills
                  .filter((s) => s.id !== skill.id && s.tags.some((t) => skill.tags.includes(t)))
                  .slice(0, 5)
                  .map((s) => (
                    <li>
                      <a href={`${baseUrl}/skill/${s.id}`} class="flex items-center gap-3 group">
                        <div class="w-8 h-8 bg-gradient-to-br from-primary-500 to-primary-600 rounded-md flex items-center justify-center text-white text-sm font-medium">
                          {s.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="flex-1 min-w-0">
                          <p class="text-sm font-medium text-gray-900 group-hover:text-primary-600 transition-colors truncate">
                            {s.name}
                          </p>
                          <p class="text-xs text-gray-500 truncate">{s.description}</p>
                        </div>
                      </a>
                    </li>
                  ))}
              </ul>
              {skillsData.skills.filter((s) => s.id !== skill.id && s.tags.some((t) => skill.tags.includes(t))).length > 5 && (
                <a href={`${baseUrl}/category/${skill.tags[0]}`} class="mt-4 block text-center text-sm text-primary-600 hover:text-primary-500">
                  查看更多 →
                </a>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  // Copy install command
  function copyInstallCommand() {
    const command = document.getElementById('install-command')?.textContent || '';
    navigator.clipboard.writeText(command).then(() => {
      // Show feedback
      const btn = document.querySelector('button[onclick="copyInstallCommand()"]');
      if (btn) {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
        setTimeout(() => {
          btn.innerHTML = originalHTML;
        }, 2000);
      }
    });
  }

  // File tree click handling (for multi-file skills)
  document.querySelectorAll('.file-tree-item').forEach((item) => {
    item.addEventListener('click', () => {
      // Update active state
      document.querySelectorAll('.file-tree-item').forEach((i) => {
        i.classList.remove('bg-primary-100', 'text-primary-800');
        i.classList.add('hover:bg-gray-100', 'text-gray-700');
      });
      item.classList.remove('hover:bg-gray-100', 'text-gray-700');
      item.classList.add('bg-primary-100', 'text-primary-800');

      // In a real implementation, this would load the file content dynamically
      // For now, we just show the first file content statically
    });
  });
</script>
